{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
    <h1 class='thin'>Upload teaching activities</h1>
    <p>You can download the teaching activities from Compass in CSV format. You need to upload them with the following columns:</p>
    <dl>
        <dt>ID</dt><dd>the ID number of the activity as stored in Compass</dd>
        <dt>Name</dt><dd>the name of the activity</dd>
        <dt>Block</dt><dd>the block number for the activity</dd>
        <dt>Week</dt><dd>the week of the block containing the activity</dd>
        <dt>Position</dt><dd>specifies the ordering of activities in the week. Called sequence number in Compass.</dd>
        <dt>Teaching Activity Type</dt><dd>the type of activity. Currently accepts {{ accepted_types|humanize_list }}</dd>
    </dl>
    <p>The first row of the file should be the column headings, spelt the same as above (case and ordering don't matter). Any extra columns are ignored.</p>
    {% if tab %}
    <div class="span10">
        <form method="post" class="form-horizontal">
            {% csrf_token %}
            <div>
                <p>Please check that the following information is correct before saving it to the database.
            </div>
            <table class="table">
                <tr>
                    <th class="lead">Name</th>
                    <th class="lead">Block</th>
                    <th class="lead">Week</th>
                    <th class="lead">Position</th>
                    <th class="lead">Type</th>
                </tr>
                {% for b, ta in tab.iteritems %}
                    {% for t in ta %}
                        <tr>
                            <td>{{ t.name }}<input type="hidden" value="{{ t.id }}" name="id" /><input type="hidden" value="{{ t.name }}" name="name_{{ t.id}}" /></td>
                            <td>{{ b.name }}<input type="hidden" value="{{ b.number }}" name="block_{{ t.id }}" /></td>
                            <td>{{ t.week }}<input type="hidden" value="{{ t.week }}" name="week_{{ t.id }}" /></td>
                            <td>{{ t.position }}<input type="hidden" value="{{ t.position }}" name="position_{{ t.id }}" /></td>
                            <td>{{ t.get_activity_type_display }}<input type="hidden" value="{{ t.activity_type }}" name="activity_type_{{ t.id }}" /></td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </table>
            {% for b in new_blocks %}
                <input type="hidden" name="new_block" value="{{ b.number }}" />
                <input type="hidden" name="new_block_{{ b.number }}_name" value="{{ b.name }}" />
                <input type="hidden" name="new_block_{{ b.number }}_year" value="{{ b.year }}" />
                <input type="hidden" name="new_block_{{ b.number }}_stage" value="{{ b.stage }}" />
                <input type="hidden" name="new_block_{{ b.number }}_start" value="{{ b.start }}" />
                <input type="hidden" name="new_block_{{ b.number }}_end" value="{{ b.end }}" />
                <input type="hidden" name="new_block_{{ b.number }}_end" value="{{ b.end }}" />
            {% endfor %}
            <input type="hidden" name="year" value="{{ year }}" />
            <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
    {% else %}
        {% if errors or already_exist %}
        <div class="span9">
            <p>Some rows in the uploaded file were not valid. Please double check the file and upload again.</p>
            <div class="text-center">
            <a class="btn btn-primary" href="{% url 'questions.views.new_ta_upload' %}">Try again</a>
            </div>
        </div>
        {% if errors %}
            <div class="span9 spacer">
                <p>The following entries in the file had errors.</p>
                <table class="table">
                    <tr><th>ID</th><th>Name</th><th>Week</th><th>Position</th></tr>
                    {% for e in errors %}
                        <tr><td>{{ e.id }}</td><td>{{ e.name }}</td><td>{{ e.week }}</td><td>{{ e.position }}</td></tr>
                    {% endfor %}
                </table>
            </div>            
        {% endif %}
        {% if already_exist %}
            <div class="span9 spacer">
                <p>The following entries in the file had positions which were already in the database for this block.</p>
                <table class="table">
                    <tr><th>ID</th><th>Name</th><th>Week</th><th>Position</th></tr>
                    {% for e in already_exist %}
                        <tr><td>{{ e.id }}</td><td>{{ e.name }}</td><td>{{ e.week }}</td><td>{{ e.position }}</td></tr>
                    {% endfor %}
                </table>
            </div>     
        {% endif %}
        {% else %}
        {% if duplicates %}
        <div class="span9">
            <p>The following teaching activity duplicates were found. Please double check the file and upload again.</p>
            <div class="text-center">
            <a class="btn btn-primary" href="{% url 'questions.views.new_ta_upload' %}">Try again</a>
            </div>
            {% for d in dup_by_name %}
                {% if forloop.first %}
                    <h4>Duplicates by name</h4>
                    <p>The following teaching activities have the same name.</p>
                {% endif %}
                <table class="table">
                    <tr><th>ID</th><th>Name</th><th>Week</th><th>Position</th></tr>
                    {% for dd in d %}
                        <tr><td>{{ dd.id }}</td><td>{{ dd.name }}</td><td>{{ dd.week }}</td><td>{{ dd.position }}</td></tr>
                    {% endfor %}
                </table>
            {% endfor %}

            {% for d in dup_by_position %}
                {% if forloop.first %}
                    <h4>Duplicates by position</h4>
                    <p>The following teaching activities have the same position.</p>
                {% endif %}
                <table class="table">
                    <tr><th>ID</th><th>Name</th><th>Week</th><th>Position</th></tr>
                    {% for dd in d %}
                        <tr><td>{{ dd.id }}</td><td>{{ dd.name }}</td><td>{{ dd.week }}</td><td>{{ dd.position }}</td></tr>
                    {% endfor %}
                </table>
            {% empty %}
                <p>There are no duplicates by position</p>
            {% endfor %}
        {% else %}
        {% if block_errors %}
            <h3>Errors</h3>
            <p>The following problems were found with the teaching blocks:</p>
            <ul>
                {% for b in block_errors %}
                    <li>{{ b }}</li>                    
                {% endfor %}
            </ul>
            <p>You might need to add the block first through the admin page. Otherwise, try double-checking the fie and trying again.</p>
        {% else %}
            <form enctype="multipart/form-data" method="post" class="form-horizontal">
                <div class="row">
                    {% csrf_token %}
                    {% include "form.html" %}
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        {% endif %}
        {% endif %}
        {% endif %}
    {% endif %}
{% endblock content %}